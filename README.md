# The melon field backend
The backend service for the melon field, it will mostly handle the search queue, fetching latest "melon-field" posts from zfrontier, and identity users from Xianyu with their profile shared (mostlikely they are related to the post, and thus might have been mishaving).

## Components

### Crawler

A python script that crawls the zfrontier website and extracts the data into a csv file.

#### Usage

```bash
python crawler/zf_crawler.py --mobile 1234567890 --password 1234567890 --log-level DEBUG
```

#### Limitations
Due to the rate limiting of the website, the crawler will sleep for 10 minutes when it receives `{"ok":20001,"msg":"操作太频繁了","data":[]}`

#### Payload Param "t" generation
The payload param "t" is generated by the following formula:

```python
t = hashlib.md5((current_time + x_csrf_token).encode()).hexdigest()
```

which is retrived from the common.35bcab358f7e7f2c4cb3.js file in the zfrontier website, and the function is obfuscated with `JSFuck`, but it has its own problem as described here: https://stackoverflow.com/questions/31862135/how-to-decode-a-jsfuck-script, and it turns out to be: `md5(time+window.csrf_token)` (and that csrf_token can be whatever you want).

```javascript
e.A = function(t) {
window.time = parseInt((new Date).getTime() / 1e3) - window.time_diff, window.md5 = _;
var e = [][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]][([][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]] + [])[!+[] + !+[] + !+[]] + (!0 + [][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]])[+!+[] + [+[]]] + ([][
......... (Shortened to save space)
] + [])[+!+[]] + (!0 + [])[+[]] + ([][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]] + [])[!+[] + !+[] + !+[]] + (!0 + [][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]])[+!+[] + [+[]]] + (!1 + [])[!+[] + !+[]] + (!0 + [][(!1 + [])[+[]] + (!1 + [])[!+[] + !+[]] + (!1 + [])[+!+[]] + (!0 + [])[+[]]])[+!+[] + [+[]]] + (!0 + [])[+!+[]]]()[+!+[] + [!+[] + !+[]]])());
return r()({
    time: window.time,
    t: e
}, t || {})
}
```

#### TODO
- [ ] Add a script to read the csv file and save the data to a database


### Search Engine/Queue

More to come in this part as this is the most important part of the system, but we need to have all the data in order to proceed.

### Xianyu Profile QR code scanner

Nothing special with scanning QR code, but the problem is that Xianyu does not provide any desktop/web version of their application, that is, we probably need to figure out some way to identify the username provided in search and the username appeared in the QR code.

#### TODO
- [ ] Add a script to scan the QR code and save the data to a database
- [ ] Add a script to read the database and save the data to a csv file